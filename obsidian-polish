#!/bin/bash
# Obsidian Note Polish Workflow
# Generates title + frontmatter and optionally inserts into file
#
# Usage:
#   obsidian-polish note.md                    # Edit file in-place (with backup)
#   obsidian-polish note.md --no-backup        # Edit without backup
#   obsidian-polish note.md -o output.md       # Save to new file
#   cat note.md | obsidian-polish              # Pipe mode (stdout)
#   pbpaste | obsidian-polish                  # Clipboard mode

set -e
set -o pipefail

# Detect which fabric command is available
if command -v fabric-ai &> /dev/null; then
    FABRIC_CMD="fabric-ai"
elif command -v fabric &> /dev/null; then
    FABRIC_CMD="fabric"
else
    echo "Error: Neither 'fabric' nor 'fabric-ai' command found."
    echo "Please install fabric: https://github.com/danielmiessler/fabric"
    exit 1
fi

# Colors
GREEN='\033[0;32m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BOLD='\033[1m'
DIM='\033[2m'
NC='\033[0m'

# Helper functions
print_section() {
    echo -e "\n${BOLD}${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${BOLD}${BLUE}$1${NC}"
    echo -e "${BOLD}${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}\n"
}

print_status() {
    echo -e "${CYAN}▶${NC} $1"
}

print_success() {
    echo -e "${GREEN}✓${NC} $1"
}

print_error() {
    echo -e "${RED}✗${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}⚠${NC} $1"
}

show_help() {
    echo -e "${BOLD}Obsidian Note Polish Workflow${NC}"
    echo ""
    echo "Usage:"
    echo "  ${BOLD}File Editing Mode:${NC}"
    echo "    obsidian-polish note.md                  # Edit in-place (creates backup)"
    echo "    obsidian-polish note.md --no-backup      # Edit without backup"
    echo "    obsidian-polish note.md -o output.md     # Save to new file"
    echo ""
    echo "  ${BOLD}Pipe Mode:${NC}"
    echo "    cat note.md | obsidian-polish            # Output to stdout + clipboard"
    echo "    pbpaste | obsidian-polish                # From clipboard"
    echo "    xclip -o | obsidian-polish               # From clipboard (Linux)"
    echo ""
    echo "Options:"
    echo "  -o, --output FILE       Save to different file"
    echo "  --no-backup             Don't create .bak file (for in-place edit)"
    echo "  -t, --title-only        Generate only title"
    echo "  -f, --frontmatter-only  Generate only frontmatter"
    echo "  -y, --yes               Skip confirmation prompts"
    echo "  -h, --help              Show this help"
    echo ""
    echo "Modes:"
    echo "  ${BOLD}Default:${NC} Combined (title + frontmatter)"
    echo "  ${BOLD}--title-only:${NC} Uses obsidian_note_title pattern"
    echo "  ${BOLD}--frontmatter-only:${NC} Uses obsidian_frontmatter_gen pattern"
    echo ""
    echo "Examples:"
    echo "  obsidian-polish meeting-notes.md          # Smart edit with backup"
    echo "  obsidian-polish draft.md --no-backup -y   # Quick edit, no prompts"
    echo "  pbpaste | obsidian-polish                 # Review before applying"
    echo ""
    exit 0
}

# Parse arguments
INPUT_FILE=""
OUTPUT_FILE=""
MODE="combined"
NO_BACKUP=false
AUTO_YES=false
EDIT_IN_PLACE=false

# Check if first argument is a file (file editing mode)
if [ $# -gt 0 ] && [ -f "$1" ]; then
    INPUT_FILE="$1"
    EDIT_IN_PLACE=true
    shift
fi

while [[ $# -gt 0 ]]; do
    case $1 in
        -o|--output)
            OUTPUT_FILE="$2"
            EDIT_IN_PLACE=false
            shift 2
            ;;
        --no-backup)
            NO_BACKUP=true
            shift
            ;;
        -y|--yes)
            AUTO_YES=true
            shift
            ;;
        -t|--title-only)
            MODE="title-only"
            shift
            ;;
        -f|--frontmatter-only)
            MODE="frontmatter-only"
            shift
            ;;
        -h|--help)
            show_help
            ;;
        *)
            print_error "Unknown option: $1"
            echo "Use -h or --help for usage information"
            exit 1
            ;;
    esac
done

echo -e "${BOLD}${BLUE}╔════════════════════════════════════════╗${NC}"
echo -e "${BOLD}${BLUE}║   Obsidian Note Polish Workflow      ║${NC}"
echo -e "${BOLD}${BLUE}╚════════════════════════════════════════╝${NC}\n"

# Step 1: Get input
if [ -n "$INPUT_FILE" ]; then
    if [ ! -f "$INPUT_FILE" ]; then
        print_error "File not found: $INPUT_FILE"
        exit 1
    fi
    print_status "Reading from file: $INPUT_FILE"
    NOTE_CONTENT=$(cat "$INPUT_FILE")
elif [ -p /dev/stdin ]; then
    print_status "Reading from stdin..."
    NOTE_CONTENT=$(cat)
    EDIT_IN_PLACE=false
else
    print_error "No input provided."
    echo ""
    echo -e "${YELLOW}Usage:${NC}"
    echo -e "  ${DIM}obsidian-polish note.md${NC}       # Edit file"
    echo -e "  ${DIM}cat note.md | obsidian-polish${NC} # Pipe mode"
    echo -e "  ${DIM}pbpaste | obsidian-polish${NC}     # Clipboard"
    echo ""
    exit 1
fi

# Validate input
if [ -z "$NOTE_CONTENT" ]; then
    print_error "Empty input received"
    exit 1
fi

print_success "Captured ${#NOTE_CONTENT} characters"

# Display preview
echo -e "\n${DIM}Preview:${NC}"
echo -e "${DIM}$(echo "$NOTE_CONTENT" | head -c 200)...${NC}\n"

# Step 2: Check if file already has frontmatter
HAS_FRONTMATTER=false
if echo "$NOTE_CONTENT" | head -1 | grep -q "^---$"; then
    HAS_FRONTMATTER=true
    print_warning "Note already has frontmatter"
    
    if [ "$EDIT_IN_PLACE" = true ] && [ "$AUTO_YES" = false ]; then
        echo -e "${YELLOW}Replace existing frontmatter? [y/N]:${NC} "
        read -r CONFIRM
        if [[ ! "$CONFIRM" =~ ^[Yy]$ ]]; then
            print_status "Cancelled by user"
            exit 0
        fi
    fi
fi

# Step 3: Generate metadata
print_section "Generating Metadata"

case $MODE in
    "title-only")
        print_status "Running obsidian_note_title..."
        TEMP_FILE=$(mktemp)
        trap "rm -f $TEMP_FILE" EXIT
        
        echo "$NOTE_CONTENT" | $FABRIC_CMD -p obsidian_note_title > "$TEMP_FILE" 2>&1
        TITLE=$(cat "$TEMP_FILE")
        
        if [ -z "$TITLE" ]; then
            print_error "Title generation failed"
            exit 1
        fi
        
        print_success "Generated title: $TITLE"
        FRONTMATTER=""
        ;;
        
    "frontmatter-only")
        print_status "Running obsidian_frontmatter_gen..."
        TEMP_FILE=$(mktemp)
        trap "rm -f $TEMP_FILE" EXIT
        
        echo "$NOTE_CONTENT" | $FABRIC_CMD -p obsidian_frontmatter_gen > "$TEMP_FILE" 2>&1
        FRONTMATTER=$(cat "$TEMP_FILE")
        
        if [ -z "$FRONTMATTER" ]; then
            print_error "Frontmatter generation failed"
            exit 1
        fi
        
        print_success "Generated frontmatter"
        TITLE=""
        ;;
        
    "combined")
        print_status "Running obsidian_note_polish..."
        TEMP_FILE=$(mktemp)
        trap "rm -f $TEMP_FILE" EXIT
        
        echo "$NOTE_CONTENT" | $FABRIC_CMD -p obsidian_note_polish > "$TEMP_FILE" 2>&1
        RESULT=$(cat "$TEMP_FILE")
        
        if [ -z "$RESULT" ]; then
            print_error "Generation failed"
            exit 1
        fi
        
        # Parse the combined result
        TITLE=$(echo "$RESULT" | grep "^TITLE:" | sed 's/^TITLE: //')
        
        # Extract frontmatter (everything after "FRONTMATTER:" line until we find the closing ---)
        FRONTMATTER=$(echo "$RESULT" | awk '
            /^FRONTMATTER:/ { inFM=1; next }
            inFM { 
                if (/^---$/) {
                    if (seenFirstDashes) {
                        print $0
                        exit
                    }
                    seenFirstDashes=1
                }
                if (inFM) print $0
            }
        ')
        
        print_success "Generated title and frontmatter"
        ;;
esac

# Step 4: Build the enhanced note
print_section "Building Enhanced Note"

ENHANCED_NOTE=""

# Add frontmatter if generated
if [ -n "$FRONTMATTER" ]; then
    ENHANCED_NOTE="$FRONTMATTER"
fi

# Remove existing frontmatter from original content if present
CLEAN_CONTENT="$NOTE_CONTENT"
if [ "$HAS_FRONTMATTER" = true ]; then
    # Remove everything from first --- to second --- (inclusive)
    CLEAN_CONTENT=$(echo "$NOTE_CONTENT" | awk '
        BEGIN { inFrontmatter=0; frontmatterDone=0; }
        /^---$/ { 
            if (!frontmatterDone) {
                inFrontmatter = !inFrontmatter;
                if (!inFrontmatter) {
                    frontmatterDone = 1;
                }
                next;
            }
        }
        !inFrontmatter && frontmatterDone { print }
    ')
fi

# Add title as H1 if generated and not already present
if [ -n "$TITLE" ]; then
    # Check if content already starts with H1
    FIRST_LINE=$(echo "$CLEAN_CONTENT" | head -1 | xargs)
    if [[ "$FIRST_LINE" == "#"* ]]; then
        print_status "Replacing existing title"
        CLEAN_CONTENT=$(echo "$CLEAN_CONTENT" | tail -n +2)
    fi
    
    if [ -n "$ENHANCED_NOTE" ]; then
        ENHANCED_NOTE="${ENHANCED_NOTE}\n\n# ${TITLE}"
    else
        ENHANCED_NOTE="# ${TITLE}"
    fi
fi

# Add the clean content
if [ -n "$ENHANCED_NOTE" ]; then
    ENHANCED_NOTE="${ENHANCED_NOTE}\n\n${CLEAN_CONTENT}"
else
    ENHANCED_NOTE="$CLEAN_CONTENT"
fi

# Step 5: Output/Write
if [ "$EDIT_IN_PLACE" = true ]; then
    print_section "Editing File In-Place"
    
    # Create backup unless disabled
    if [ "$NO_BACKUP" = false ]; then
        BACKUP_FILE="${INPUT_FILE}.bak"
        cp "$INPUT_FILE" "$BACKUP_FILE"
        print_success "Backup created: $BACKUP_FILE"
    fi
    
    # Write enhanced content
    echo -e "$ENHANCED_NOTE" > "$INPUT_FILE"
    print_success "File updated: $INPUT_FILE"
    
    # Show preview of changes
    echo -e "\n${DIM}Updated file preview:${NC}"
    head -20 "$INPUT_FILE"
    echo -e "${DIM}...${NC}\n"
    
elif [ -n "$OUTPUT_FILE" ]; then
    print_section "Writing to File"
    
    echo -e "$ENHANCED_NOTE" > "$OUTPUT_FILE"
    print_success "Saved to: $OUTPUT_FILE"
    
    echo -e "\n${DIM}Preview:${NC}"
    head -20 "$OUTPUT_FILE"
    echo -e "${DIM}...${NC}\n"
    
else
    # Pipe mode - output to stdout and clipboard
    print_section "RESULT"
    
    echo -e "$ENHANCED_NOTE"
    
    echo ""
    print_status "Copying to clipboard..."
    
    if command -v pbcopy &> /dev/null; then
        echo -e "$ENHANCED_NOTE" | pbcopy
        print_success "Copied to clipboard!"
    elif command -v xclip &> /dev/null; then
        echo -e "$ENHANCED_NOTE" | xclip -selection clipboard
        print_success "Copied to clipboard!"
    else
        print_warning "No clipboard utility found"
    fi
fi

echo -e "\n${BOLD}${GREEN}✨ Workflow complete!${NC}\n"
